---
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Zabbix Agent
- name: üß© Install Zabbix agent
  apt:
    name: zabbix-agent
    state: present
    update_cache: yes
  become: yes

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Zabbix
- name: ‚öôÔ∏è Ensure /etc/zabbix directory exists
  file:
    path: /etc/zabbix
    state: directory
    owner: root
    group: root
    mode: '0755'

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤
- name: ‚öôÔ∏è Ensure /etc/zabbix/zabbix_agentd.d directory exists
  file:
    path: /etc/zabbix/zabbix_agentd.d
    state: directory
    owner: root
    group: root
    mode: '0755'

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- name: ‚öôÔ∏è Create base zabbix_agentd.conf if missing
  copy:
    dest: /etc/zabbix/zabbix_agentd.conf
    content: |
      LogFile=/var/log/zabbix/zabbix_agentd.log
      LogFileSize=0
      Server=10.8.0.1
      Hostname={{ inventory_hostname }}
      Include=/etc/zabbix/zabbix_agentd.d/*.conf
    owner: root
    group: root
    mode: '0644'
    force: no  # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å

# –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –ª–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- name: ‚öôÔ∏è Ensure log directory exists
  file:
    path: /var/log/zabbix
    state: directory
    owner: zabbix
    group: zabbix
    mode: '0755'

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Ñ–∏–≥–µ (–µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª)
- name: ‚öôÔ∏è Update zabbix_agentd.conf parameters
  lineinfile:
    path: /etc/zabbix/zabbix_agentd.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^Server=', line: 'Server=10.8.0.1' }
    - { regexp: '^Hostname=', line: "Hostname={{ inventory_hostname }}" }
    - { regexp: '^LogFile=', line: 'LogFile=/var/log/zabbix/zabbix_agentd.log' }

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–ª—É–∂–±—ã
- name: üß† Detect which Zabbix Agent service is installed
  shell: systemctl list-unit-files | grep -E '^zabbix-agent[0-9]*\.service'
  register: zabbix_service
  changed_when: false

- name: ü™∂ Debug which Zabbix service was detected
  debug:
    msg: "Detected service: {{ zabbix_service.stdout | default('undefined') }}"

# –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
- name: üöÄ Ensure Zabbix Agent service is started and enabled
  systemd:
    name: "{{ (zabbix_service.stdout_lines | first | regex_search('^zabbix-agent[0-9]*')) | default('zabbix-agent') }}"
    state: started
    enabled: yes
  become: yes

