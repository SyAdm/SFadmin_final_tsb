---
- name: Check connectivity and environment of all hosts
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  become: false

  tasks:
    - name: 🔹 Проверка SSH-доступности (ping module)
      ansible.builtin.ping:

    - name: 🔹 Проверка возможности подключения по SSH (whoami)
      ansible.builtin.command: whoami
      register: whoami_result
      changed_when: false
      ignore_errors: true

    - name: Вывод текущего пользователя
      ansible.builtin.debug:
        msg: "Текущий пользователь на {{ inventory_hostname }}: {{ whoami_result.stdout | default('недоступно (check mode или ошибка)') }}"
      when: whoami_result is defined

    - name: 🔹 Проверка, что Ansible может собирать факты
      ansible.builtin.setup:
      register: facts_result
      ignore_errors: true

    - name: Проверка фактов
      ansible.builtin.debug:
        msg: >
          {{ inventory_hostname }}:
          OS={{ facts_result.ansible_facts['ansible_distribution'] | default('N/A') }}
          Version={{ facts_result.ansible_facts['ansible_distribution_version'] | default('N/A') }}
          IP={{ facts_result.ansible_facts['ansible_default_ipv4']['address'] | default('N/A') }}
      when: facts_result is defined

